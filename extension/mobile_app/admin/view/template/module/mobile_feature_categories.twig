{{ header }}
{{ column_left }}
<div id="content">
	<div class="page-header">
		<div class="container-fluid">
			<div class="float-end">
				<button type="submit" form="form-module" data-bs-toggle="tooltip" title="{{ button_save }}" class="btn btn-primary">
					<i class="fa-solid fa-save"></i>
				</button>
				<a href="{{ back }}" data-bs-toggle="tooltip" title="{{ button_back }}" class="btn btn-light">
					<i class="fa-solid fa-reply"></i>
				</a>
			</div>
			<h1>
				{{ heading_title }}
			</h1>
			<ol class="breadcrumb">
				{% for breadcrumb in breadcrumbs %}
					<li class="breadcrumb-item">
						<a href="{{ breadcrumb.href }}">
							{{ breadcrumb.text }}
						</a>
					</li>
				{% endfor %}
			</ol>
		</div>
	</div>
	<div class="container-fluid">
		<div class="card">
			<div class="card-header">
				<i class="fa-solid fa-pencil"></i>
				{{ text_edit }}
			</div>
			<div class="card-body">
				<form id="form-module" action="{{ save }}" method="post" data-oc-toggle="ajax">
					<div class="row mb-3">
						<label class="col-sm-2 col-form-label">
							{{ entry_status }}
						</label>
						<div class="col-sm-10">
							<div class="form-check form-switch form-switch-lg">
								<input type="hidden" name="module_mobile_app_feature_category_status" value="0"/>
								<input type="checkbox" name="module_mobile_app_feature_category_status" value="1" id="input-status" class="form-check-input" {% if module_mobile_app_feature_category_status %} checked {% endif %}/>
							</div>
						</div>
					</div>
					<div class="table-responsive">
						<table id="categories-products" class="table table-bordered table-hover align-middle">
							<thead>
								<tr>
									<td class="text-start">
										Category
									</td>
									<td class="text-start">
										Products
									</td>
									<td class="text-end">
										Action
									</td>
								</tr>
							</thead>
							<tbody>
								{% set item_row = 0 %}
								{% for item in home_page_categories %}
									<tr
										id="item-row-{{ item_row }}">
										<!-- Category -->
										<td class="text-start" style="width: 30%; padding:8px 12px;">
											<div class="input-group" style="margin:0;">
												<input type="text" name="module_mobile_app_feature_category_items[{{ item_row }}][category_name]" value="{{ item.name }}" placeholder="Category" id="input-category-{{ item_row }}" data-oc-target="autocomplete-category-{{ item_row }}" class="form-control" autocomplete="off" style="padding:6px 10px;"/>
												<ul id="autocomplete-category-{{ item_row }}" class="dropdown-menu mt-5"></ul>
											</div>
											<input type="hidden" name="module_mobile_app_feature_category_items[{{ item_row }}][category_id]" value="{{ item.category_id }}"/>
										</td>

										<!-- Products -->
										<td class="text-start" style="padding:8px 12px;">
											<div class="input-group" style="margin:0;">
												<input type="text" placeholder="Products" id="input-product-{{ item_row }}" data-oc-target="autocomplete-product-{{ item_row }}" class="form-control" autocomplete="off" style="padding:6px 10px;"/>
												<ul id="autocomplete-product-{{ item_row }}" class="dropdown-menu mt-5"></ul>
											</div>
											<div class="scrollbox mt-2 border rounded p-2" style="height:150px; overflow:auto;">
												{% for product in item.products %}
													<div id="item-{{ item_row }}-product-{{ product.product_id }}" class="mb-1">
														<i class="fa-solid fa-minus-circle text-danger"></i>
														{{ product.name }}
														<input type="hidden" name="module_mobile_app_feature_category_items[{{ item_row }}][product][]" value="{{ product.product_id }}"/>
													</div>
												{% endfor %}
											</div>
										</td>

										<!-- Action -->
										<td class="text-end" style="padding:8px 12px;">
											<button type="button" onclick="$('#item-row-{{ item_row }}').remove();" data-bs-toggle="tooltip" title="{{ button_remove }}" class="btn btn-danger">
												<i class="fa-solid fa-minus-circle"></i>
											</button>
										</td>
									</tr>
									{% set item_row = item_row + 1 %}
								{% endfor %}
							</tbody>
							<tfoot>
								<tr>
									<td colspan="2"></td>
									<td class="text-end">
										<button type="button" onclick="addItem();" data-bs-toggle="tooltip" title="{{ button_add }}" class="btn btn-primary">
											<i class="fa-solid fa-plus-circle"></i>
										</button>
									</td>
								</tr>
							</tfoot>
						</table>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

 <script type="text/javascript">
  var item_row = {{ item_row }};

  function addItem() {
    var html  = '<tr id="item-row-' + item_row + '">';
    html += '  <td class="text-start" style="width:30%; padding:8px 12px;">';
    html += '    <div class="input-group">';
    html += '      <input type="text" name="module_mobile_app_feature_category_items[' + item_row + '][category_name]" value="" placeholder="Category" id="input-category-' + item_row + '" data-oc-target="autocomplete-category-' + item_row + '" class="form-control" autocomplete="off" style="padding:6px 10px;"/>';
    html += '      <ul id="autocomplete-category-' + item_row + '" class="dropdown-menu mt-5"></ul>';
    html += '    </div>';
    html += '    <input type="hidden" name="module_mobile_app_feature_category_items[' + item_row + '][category_id]" value="0"/>';
    html += '  </td>';

    html += '  <td class="text-start" style="padding:8px 12px;">';
    html += '    <div class="input-group">';
    html += '      <input type="text" placeholder="Products" id="input-product-' + item_row + '" data-oc-target="autocomplete-product-' + item_row + '" class="form-control" autocomplete="off" style="padding:6px 10px;"/>';
    html += '      <ul id="autocomplete-product-' + item_row + '" class="dropdown-menu mt-5"></ul>';
    html += '    </div>';
    html += '    <div class="scrollbox mt-2 border rounded p-2" style="height:150px; overflow:auto;"></div>';
    html += '  </td>';

    html += '  <td class="text-end" style="padding:8px 12px;">';
    html += '    <button type="button" onclick="$(\'#item-row-' + item_row + '\').remove();" data-bs-toggle="tooltip" title="{{ button_remove }}" class="btn btn-danger"><i class="fa-solid fa-minus-circle"></i></button>';
    html += '  </td>';
    html += '</tr>';

    $('#categories-products tbody').append(html);

    initAutocomplete(item_row);
    item_row++;
  }

  function initAutocomplete(row_id) {
    var row = $('#item-row-' + row_id);

    $('#input-category-' + row_id).autocomplete({
      'source': function (request, response) {
        $.ajax({
          url: 'index.php?route=catalog/category.autocomplete&user_token={{ user_token }}&filter_name=' + encodeURIComponent(request),
          dataType: 'json',
          success: function (json) {
            response($.map(json, function (item) {
              return { label: item['name'], value: item['category_id'] }
            }));
          }
        });
      },
      'select': function (item) {
        $('#input-category-' + row_id).val(item['label']);
        row.find('input[name*="[category_id]"]').val(item['value']);
        row.find('.scrollbox').html('');
      }
    });

    $('#input-category-' + row_id).on('change', function() {
        if ($(this).val() === '') {
            row.find('input[name*="[category_id]"]').val('0');
            row.find('.scrollbox').html('');
        }
    });

    $('#input-product-' + row_id).autocomplete({
      'source': function (request, response) {
        var category_id = row.find('input[name*="[category_id]"]').val();
        if (!category_id || category_id == '0') {
          return;
        }
        $.ajax({
          url: 'index.php?route=extension/mobile_app/module/mobile_app.product_autocomplete&user_token={{ user_token }}&filter_name=' + encodeURIComponent(request) + (category_id ? '&filter_category_id=' + category_id : ''),
          dataType: 'json',
          success: function (json) {
            response($.map(json, function (item) {
              return { label: item['name'], value: item['product_id'] }
            }));
          }
        });
      },
      'select': function (item) {
        $('#input-product-' + row_id).val('');
        var productBox = row.find('.scrollbox');
        if (productBox.find('#item-' + row_id + '-product-' + item['value']).length == 0) {
          productBox.append('<div id="item-' + row_id + '-product-' + item['value'] + '" class="mb-1"><i class="fa-solid fa-minus-circle text-danger"></i> ' + item['label'] + '<input type="hidden" name="module_mobile_app_feature_category_items[' + row_id + '][product][]" value="' + item['value'] + '"/></div>');
        }
      }
    });

    $('#input-product-' + row_id).on('focus', function() {
        var category_id = row.find('input[name*="[category_id]"]').val();
        if (!category_id || category_id == '0') {
            alert('Please select a category first.');
            $(this).blur();
        }
    });
  }

  $('#categories-products tbody tr').each(function () {
    var row_id = $(this).attr('id').replace('item-row-', '');
    initAutocomplete(row_id);
  });

  $('#categories-products tbody').on('click', '.fa-minus-circle', function () {
    $(this).parent().remove();
  });
</script>
{{ footer }}
